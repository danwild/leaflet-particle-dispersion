"use strict";L.ParticleDispersionLayer=(L.Layer?L.Layer:L.Class).extend({_pidIndex:0,_pLatIndex:1,_pLonIndex:0,_pDepthIndex:2,_pAgeIndex:3,_particleLayer:null,_frameIndex:0,_markers:[],_colors:null,options:{data:null,displayMode:"",startFrameIndex:0,ageColorScale:null,ageDomain:null},_active:!1,_map:null,_renderer:null,_pane:null,initialize:function(e){L.setOptions(this,e)},onAdd:function(e){this._active=!0,console.log("options"),console.log(this.options),this._map=e,this.options.hasOwnProperty("startFrameIndex")&&(this._frameIndex=this.options.startFrameIndex),this.options.ageColorScale=this.options.ageColorScale||["green","yellow","red"],this.options.ageDomain=this.options.ageDomain||null,this._createRenderer(),this.options.displayMode&&this.setDisplayMode(this.options.displayMode)},onRemove:function(){this._map.removeLayer(this._particleLayer),L.DomUtil.remove(this._pane),this._renderer=null,this._particleLayer=null,this._active=!1},isActive:function(){return this._active},setData:function(e){this.options.data=e,this.setDisplayMode(this.options.displayMode)},setDisplayMode:function(e){if(this.options.displayMode=e,this.isActive())switch(this.options.displayMode){case"EXPOSURE":this._initDisplayExposure();break;case"FINAL":this._initDisplayFinal();break;case"KEYFRAME":this._initDisplayKeyframe();break;default:console.error("Attempted to initialise with invalid displayMode: "+this.options.displayMode)}},setFrameIndex:function(e){if(this.isActive()){var t=this;t._frameIndex=e;var i=Object.keys(t.options.data),a=t.options.data[i[e]];t._particleLayer&&t._particleLayer.clearLayers();for(var s=0;s<a.length;s++){var r=a[s],o=t._map.wrapLatLng([r[t._pLatIndex],r[t._pLonIndex]]),n=L.circleMarker(o,{renderer:t._renderer,stroke:!1,fillOpacity:.3,radius:8,fillColor:this._colors(r[t._pAgeIndex]).hex(),_feature:r}).bindTooltip("I love to parti-cle..",{sticky:!0});t._markers.push(n),t._particleLayer.addLayer(n)}}},_createRenderer:function(){this._pane=this._map.createPane("particle-dispersion"),this._renderer=L.canvas({pane:"particle-dispersion"})},_clearDisplay:function(){this._particleLayer&&this._map.removeLayer(this._particleLayer),this._particleLayer=null},_createColors:function(){return this.options.ageDomain||(this.options.ageDomain=[0,Object.keys(this.options.data).length]),this._colors=chroma.scale(this.options.ageColorScale).domain(this.options.ageDomain),this._colors},_initDisplayFinal:function(){if(this._clearDisplay(),this.options.data){this._createColors();var e=this._createFinalData();this._particleLayer=L.heatLayer(e,{radius:15}),this._particleLayer.addTo(this._map)}},_createFinalData:function(){var e=this,t=[],i=Object.keys(this.options.data);i.sort(function(e,t){return new Date(e)-new Date(t)});var a=[];i.forEach(function(t){a=a.concat(e.options.data[t])});var s=[];a.forEach(function(t){s.indexOf(t[e._pidIndex])===-1&&s.push(t[e._pidIndex])}),i.reverse();for(var r=0;r<i.length&&0!==s.length;r++)this.options.data[i[r]].forEach(function(i){var a=s.indexOf(i[e._pidIndex]);a!==-1&&(t.push([i[e._pLatIndex],i[e._pLonIndex],.9]),s.splice(a,1))});return t},_createExposureData:function(){var e=this,t=[],i=Object.keys(this.options.data);Object.keys(this.options.data).length;return i.forEach(function(i){e.options.data[i].forEach(function(i){t.push([i[e._pLatIndex],i[e._pLonIndex],.2])})}),t},_initDisplayExposure:function(){if(this._clearDisplay(),this.options.data){this._createColors();var e=this._createExposureData();this._particleLayer=L.heatLayer(e,{radius:15}),this._particleLayer.addTo(this._map)}},_initDisplayKeyframe:function(){this._clearDisplay(),this.options.data?(this._createColors(),this._particleLayer=L.featureGroup(),this._markers=[],this.setFrameIndex(this._frameIndex),this._particleLayer.addTo(this._map)):console.error("Attempted to display keyframes but there is no data.")}}),L.particleDispersionLayer=function(e){return new L.ParticleDispersionLayer(e)};