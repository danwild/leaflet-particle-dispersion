"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){"function"==typeof define&&define.amd?define(["leaflet","leaflet.heat","chroma-js"],e):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=e(require("leaflet"),require("leaflet.heat"),require("chroma-js"))),"undefined"!=typeof t&&t.L&&t.L.heatLayer&&t.chroma&&(t.L.particleDispersionLayer=e(L,t.L.heatLayer,t.chroma))}(function(e,t,i){var a=(e.Layer?e.Layer:e.Class).extend({_pidIndex:0,_pLatIndex:1,_pLonIndex:0,_pDepthIndex:2,_pAgeIndex:3,_particleLayer:null,_frameIndex:0,_markers:[],_colors:null,_active:!1,_map:null,_renderer:null,_pane:null,options:{data:null,displayMode:"",startFrameIndex:0,ageColorScale:null,ageDomain:null,exposureHeatOptions:{},finalHeatOptions:{},exposureIntensity:.9,finalIntensity:.9},initialize:function(e){this.options=this._extendObject(this.options,e)},onAdd:function(e){this._active=!0,this._map=e,this._createRenderer(),this.options.displayMode&&this.setDisplayMode(this.options.displayMode)},onRemove:function(){this._map.removeLayer(this._particleLayer),e.DomUtil.remove(this._pane),this._renderer=null,this._particleLayer=null,this._active=!1},isActive:function(){return this._active},setData:function(e){this.options.data=e,this.setDisplayMode(this.options.displayMode)},setDisplayMode:function(e){if(this.options.displayMode=e,this.isActive())switch(this.options.displayMode){case"EXPOSURE":this._initDisplayExposure();break;case"FINAL":this._initDisplayFinal();break;case"KEYFRAME":this._initDisplayKeyframe();break;default:console.error("Attempted to initialise with invalid displayMode: "+this.options.displayMode)}},setFrameIndex:function(t){if(this.isActive()){var i=this;i._frameIndex=t;var a=Object.keys(i.options.data),n=i.options.data[a[t]];i._particleLayer&&i._particleLayer.clearLayers();for(var r=0;r<n.length;r++){var o=n[r],s=i._map.wrapLatLng([o[i._pLatIndex],o[i._pLonIndex]]),p=e.circleMarker(s,{renderer:i._renderer,stroke:!1,fillOpacity:.3,radius:8,fillColor:this._colors(o[i._pAgeIndex]).hex(),_feature:o});i._markers.push(p),i._particleLayer.addLayer(p)}}},_createRenderer:function(){this._pane=this._map.createPane("particle-dispersion"),this._renderer=e.canvas({pane:"particle-dispersion"})},_clearDisplay:function(){this._particleLayer&&this._map.removeLayer(this._particleLayer),this._particleLayer=null},_createColors:function(){return this.options.ageDomain||(this.options.ageDomain=[0,Object.keys(this.options.data).length]),this._colors=i.scale(this.options.ageColorScale).domain(this.options.ageDomain),this._colors},_initDisplayFinal:function(){if(this._clearDisplay(),this.options.data){this._createColors();var t=this._createFinalData();this._particleLayer=e.heatLayer(t,this.options.finalHeatOptions),this._particleLayer.addTo(this._map)}},_createFinalData:function(){var e=this,t=[],i=Object.keys(this.options.data);i.sort(function(e,t){return new Date(e)-new Date(t)});var a=[];i.forEach(function(t){a=a.concat(e.options.data[t])});var n=[];a.forEach(function(t){n.indexOf(t[e._pidIndex])===-1&&n.push(t[e._pidIndex])}),i.reverse();for(var r=0;r<i.length&&0!==n.length;r++)this.options.data[i[r]].forEach(function(i){var a=n.indexOf(i[e._pidIndex]);a!==-1&&(t.push([i[e._pLatIndex],i[e._pLonIndex],e.options.finalIntensity]),n.splice(a,1))});return t},_createExposureData:function(){var e=this,t=[],i=Object.keys(this.options.data);return i.forEach(function(i){e.options.data[i].forEach(function(i){t.push([i[e._pLatIndex],i[e._pLonIndex],e.options.exposureIntensity])})}),t},_initDisplayExposure:function(){if(this._clearDisplay(),this.options.data){this._createColors();var t=this._createExposureData();this._particleLayer=e.heatLayer(t,this.options.exposureHeatOptions),this._particleLayer.addTo(this._map)}},_initDisplayKeyframe:function(){this._clearDisplay(),this.options.data?(this._createColors(),this._particleLayer=e.featureGroup(),this._markers=[],this.setFrameIndex(this._frameIndex),this._particleLayer.addTo(this._map)):console.error("Attempted to display keyframes but there is no data.")},_extendObject:function(e,t){var i=this;for(var a in t)"data"===a?e[a]=t[a]:t[a]&&t[a].constructor&&t[a].constructor===Object?(e[a]=e[a]||{},i._extendObject(e[a],t[a])):e[a]=t[a];return e}});return e.particleDispersionLayer=function(e){return new a(e)},e.particleDispersionLayer},window);