"use strict";L.ParticleDispersionLayer=(L.Layer?L.Layer:L.Class).extend({_pidIndex:0,_pLatIndex:1,_pLonIndex:0,_pDepthIndex:2,_pAgeIndex:3,_particleLayer:null,_frameIndex:0,_markers:[],_colors:null,options:{data:null,displayMode:null,startFrameIndex:0,ageColorScale:null,ageDomain:null},_map:null,_renderer:null,_pane:null,initialize:function(e){L.setOptions(this,e)},onAdd:function(e){console.log("options"),console.log(this),console.log(this.options),this._map=e,this.options.hasOwnProperty("startFrameIndex")&&(this._frameIndex=this.options.startFrameIndex),this.options.ageColorScale=this.options.ageColorScale||["green","yellow","red"],this.options.ageDomain=this.options.ageDomain||null,this._createRenderer(),this.options.displayMode&&this.setDisplayMode(this.options.displayMode)},onRemove:function(){L.DomUtil.remove(this._pane),this._renderer=null,this._particleLayer=null},setData:function(e){this.options.data=e},setDisplayMode:function(e){switch(console.log("setDisplayMode: "+e),this.options.displayMode=e,this.options.displayMode){case"EXPOSURE":this._initDisplayExposure();break;case"FINAL":this._initDisplayFinal();break;case"KEYFRAME":this._initDisplayKeyframe();break;default:console.error("Attempted to initialise with invalid displayMode: "+this.options.displayMode)}},setFrameIndex:function(e){console.log("setFrameIndex: "+e);var t=this;t._frameIndex=e;var a=Object.keys(t.options.data),i=t.options.data[a[e]];t._particleLayer&&t._particleLayer.clearLayers();for(var s=0;s<i.length;s++){var o=i[s],n=t._map.wrapLatLng([o[t._pLatIndex],o[t._pLonIndex]]),r=L.circleMarker(n,{renderer:t._renderer,stroke:!1,fillOpacity:.3,radius:8,fillColor:this._colors(o[t._pAgeIndex]).hex(),_feature:o}).bindTooltip("I love to parti-cle..",{sticky:!0});t._markers.push(r),t._particleLayer.addLayer(r)}},_createRenderer:function(){this._pane=this._map.createPane("particle-dispersion"),this._renderer=L.canvas({pane:"particle-dispersion"})},_clearDisplay:function(){this._particleLayer&&this._map.removeLayer(this._particleLayer),this._particleLayer=null},_createColors:function(){return this.options.ageDomain||(this.options.ageDomain=[0,Object.keys(this.options.data).length]),this._colors=chroma.scale(this.options.ageColorScale).domain(this.options.ageDomain),this._colors},_initDisplayFinal:function(){if(this._clearDisplay(),this.options.data){this._createColors();var e=this._createFinalData();console.log(e),this._particleLayer=L.heatLayer(e,{radius:15}),this._particleLayer.addTo(this._map)}},_createFinalData:function(){var e=this,t=[],a=Object.keys(this.options.data);a.sort(function(e,t){return new Date(e)-new Date(t)});var i=[];a.forEach(function(t){i=i.concat(e.options.data[t])});var s=[];i.forEach(function(t){s.indexOf(t[e._pidIndex])===-1&&s.push(t[e._pidIndex])}),a.reverse();for(var o=0;o<a.length&&0!==s.length;o++)this.options.data[a[o]].forEach(function(a){var i=s.indexOf(a[e._pidIndex]);i!==-1&&(t.push([a[e._pLatIndex],a[e._pLonIndex],.9]),s.splice(i,1))});return t},_getParticleLastSnapshot:function(e){},_createExposureData:function(){var e=this,t=[],a=Object.keys(this.options.data);Object.keys(this.options.data).length;return a.forEach(function(a){e.options.data[a].forEach(function(a){t.push([a[e._pLatIndex],a[e._pLonIndex],.2])})}),t},_initDisplayExposure:function(){if(this._clearDisplay(),this.options.data){this._createColors();var e=this._createExposureData();console.log(e),this._particleLayer=L.heatLayer(e,{radius:15}),this._particleLayer.addTo(this._map)}},_initDisplayKeyframe:function(){this._clearDisplay(),this.options.data?(this._createColors(),this._particleLayer=L.featureGroup(),this._markers=[],this.setFrameIndex(this._frameIndex),this._particleLayer.addTo(this._map)):console.error("Attempted to display keyframes but there is no data.")}}),L.particleDispersionLayer=function(e){return new L.ParticleDispersionLayer(e)};